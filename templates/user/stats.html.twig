{% extends 'user/layout.html.twig' %}
{% import "macros/widgets.html.twig" as widgets %}
{% import "macros/charts.html.twig" as charts %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('chart') }}
{% endblock %}

{% block head %}
    {{ parent() }}
    {{ encore_entry_script_tags('chart') }}
{% endblock %}

{% block profile_content %}
    <div class="card mb-3">
        <div class="card-body">
            <div class="card-title">{{ 'profile.about_me'|trans }}</div>
            <div class="mb-2">
                {{ 'label.username'|trans }}: <strong>{{ user.username }}</strong>
            </div>
            {% if user.accountNumber is not empty %}
                <div class="mb-2">
                    {{ 'label.account_number'|trans }}: <strong>{{ user.accountNumber }}</strong>
                </div>
            {% endif %}
            <div class="mb-2">
                {{ 'profile.first_entry'|trans }}:
                <strong>
                    {% if firstTimesheet is not null %}
                        {{ firstTimesheet|date_short }}
                    {% else %}
                        &ndash;
                    {% endif %}
                </strong>
            </div>
            <div class="mb-2">
                {{ 'profile.registration_date'|trans }}: <strong>{{ user.registeredAt|date_short }}</strong>
            </div>
            {% if is_granted('hourly-rate', user) and user.preferenceValue('hourly_rate') is not null %}
                <div>
                    {{ 'label.hourlyRate'|trans }}: <strong>{{ user.preferenceValue('hourly_rate') }}</strong>
                </div>
            {% endif %}
        </div>
    </div>

    {# BOX WITH SHORT STATS #}
    {% if stats is not null %}
    <div class="card mb-3">
        <div class="card-body text-center">
            {% set seeOwnRate = is_granted('view_rate_own_timesheet') %}
            {% set columnLength = seeOwnRate ? 3 : 6 %}
            <div class="row">
                <div class="col-sm-{{ columnLength }} border-right">
                    <div class="description-block">
                        <h5 class="description-header">{{ stats.durationThisMonth|duration }}</h5>
                        <span class="description-text">{{ 'stats.durationMonth'|trans }}</span>
                    </div>
                </div>
                {% if seeOwnRate %}
                    <div class="col-sm-{{ columnLength }} border-right">
                        <div class="description-block">
                            <h5 class="description-header">{{ stats.rateThisMonthBillable|money }}</h5>
                            <span class="description-text">{{ 'stats.amountMonth'|trans }}</span>
                        </div>
                    </div>
                {% endif %}
                <div class="col-sm-{{ columnLength }} border-right">
                    <div class="description-block">
                        <h5 class="description-header">{{ stats.durationTotal|duration }}</h5>
                        <span class="description-text">{{ 'stats.durationTotal'|trans }}</span>
                    </div>
                </div>
                {% if seeOwnRate %}
                    <div class="col-sm-{{ columnLength }} border-right">
                        <div class="description-block">
                            <h5 class="description-header">{{ stats.rateTotalBillable|money }}</h5>
                            <span class="description-text">{{ 'stats.amountTotal'|trans }}</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if workMonths is empty %}
        {{ widgets.nothing_found() }}
    {% endif %}

    {% set monthRoute = null %}
    {% set canSeeReport = user.enabled and is_granted('view_reporting') and (app.user.id == user.id or is_granted('view_other_timesheet')) %}

    {%- if canSeeReport -%}
        {% set monthRoute = path('report_user_month', {'user': user.id, 'date': '__MONTH__'}) %}
    {% endif %}

    {{ charts.bar_javascript({'footer': 'footer', 'label': 'tooltip', 'onclick': {'url': monthRoute, 'replacer': {'__MONTH__': 'month'}}}) }}

    {% for year in workMonths.years|reverse %}
        {% set totalDuration = 0 %}
        {% for month in workMonths.year(year) %}
            {% set totalDuration = totalDuration + month.duration %}
        {% endfor %}
        {% embed '@theme/embeds/card.html.twig' %}
            {% import "macros/charts.html.twig" as charts %}
            {% import "macros/widgets.html.twig" as macros %}
            {% block box_title -%}
                {{ year }} &ndash;
                {{ macros.badge_counter(totalDuration|duration) }}
            {%- endblock %}
            {% block box_tools %}
                {%- if canSeeReport -%}
                    <a class="btn btn-icon" href="{{ path('report_user_year', {'user': user.id, 'date': year ~ '-01-01'}) }}"><i class="{{ 'reporting'|icon }}"></i></a>
                {% endif %}
            {% endblock %}
            {% block box_body %}
                {% set dataset = [] %}
                {% for month in workMonths.year(year) %}
                    {% set monthDate = create_date(year ~ '-' ~ month.date.format('m') ~ '-01') %}
                    {% set dataset = dataset|merge([{'value': month.duration|chart_duration, 'tooltip': month.duration|duration, 'footer': ('label.billable'|trans ~ ': ' ~ month.billableDuration|duration), 'month': monthDate|report_date}]) %}
                {% endfor %}
                {{ charts.bar_chart('userProfileChart'~year, month_names(), [dataset], {}) }}
            {% endblock %}
        {% endembed %}
    {% endfor %}

    {% if user.teams is not empty and (is_granted('teams', user) or is_granted('view_team_member', user)) %}
        {% embed '@theme/embeds/card.html.twig' with {fullsize: true} %}
            {% import "macros/widgets.html.twig" as widgets %}
            {% block box_title %}{{ 'label.my_teams'|trans }}{% endblock %}
            {% block box_body %}
                {{ widgets.team_list(user.teams) }}
            {% endblock %}
        {% endembed %}
    {% endif %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        document.addEventListener('kimai.initialized', function() {
            KimaiReloadPageWidget.create('kimai.teamUpdate', true);
        });
    </script>
{% endblock %}
