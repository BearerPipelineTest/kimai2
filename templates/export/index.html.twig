{% extends 'base.html.twig' %}
{% import "macros/widgets.html.twig" as widgets %}
{% import "macros/datatables.html.twig" as tables %}

{% set columns = {
    'date': {'class': 'alwaysVisible text-nowrap', 'orderBy': false},
    'user': {'class': 'd-xs-none d-sm-none', 'orderBy': false},
    'project': {'class': 'd-xs-none d-sm-none', 'orderBy': false},
    'activity': {'class': 'd-xs-none d-sm-none d-md-none', 'orderBy': false},
    'description': {'class': 'd-xs-none d-sm-none d-md-none timesheet-description', 'orderBy': false},
    'unit_price': {'class': 'text-end d-none d-xs-none text-nowrap', 'orderBy': false},
    'duration': {'class': 'text-end text-nowrap', 'orderBy': false},
    'rate_internal': {'class': 'text-end d-none text-nowrap', 'orderBy': false},
    'total_rate': {'class': 'text-end text-nowrap', 'orderBy': false},
    'actions': {'class': 'actions alwaysVisible', 'orderBy': false},
} %}

{% set tableName = 'export' %}
{% set showToggleButton = preview_show and form.exported.vars.value != constant('App\\Repository\\Query\\TimesheetQuery::STATE_ALL') and entries is not empty %}

{% block page_title %}{{ 'export.title'|trans }}{% endblock %}
{% block page_actions %}
    {% set event = actions(app.user, 'export', (preview_show ? 'preview' : 'index')) %}
    {{ widgets.page_actions(event.actions) }}
{% endblock %}

{% block main_before %}
    {{ tables.data_table_column_modal(tableName, columns) }}
{% endblock %}

{% block main %}

    {% embed '@theme/embeds/card.html.twig' %}
        {% import "macros/search.html.twig" as search %}
        {% form_theme form '@theme/layout/form-theme-horizontal.html.twig' %}
        {% block box_title %}{{ 'export.filter'|trans }}{% endblock %}
        {% block box_before %}{{ form_start(form) }}{% endblock %}
        {% block box_body %}
            {{ form_errors(form) }}
            {{ form_row(form.searchTerm) }}
            {{ form_row(form.daterange) }}
            {{ form_row(form.customers) }}
            {{ form_row(form.projects) }}
            {{ form_row(form.activities) }}
            {{ form_row(form.tags) }}
            {% if form.users is defined %}
                {{ form_row(form.users) }}
            {% endif %}
            {{ form_row(form.billable) }}
            {{ form_row(form.exported) }}
            {{ form_row(form.state) }}
            {{ form_row(form.markAsExported) }}
        {% endblock %}
        {% block box_footer%}
            {{ search.searchButton(form) }}
        {% endblock %}
        {% block box_after %}{{ form_end(form) }}{% endblock %}
    {% endembed %}

    {% if too_many is same as (true) %}
        {{ widgets.callout('danger', 'error.too_many_entries') }}
    {% elseif preview_show %}
        {% if entries is empty %}
            {{ widgets.nothing_found() }}
        {% else %}
            {% embed '@theme/embeds/card.html.twig' %}
                {% import "macros/widgets.html.twig" as widgets %}
                {% block box_title %}
                    {{ 'button.preview'|trans }}: {{ 'export.title'|trans }}
                {% endblock %}
                {% block box_attributes %}id="preview_export"{% endblock %}
                {% block box_body_class %}p-0{% endblock %}
                {% block box_footer %}
                    {% set buttons = {} %}
                    {% for button in renderer %}
                        {% set title = button.title %}
                        {% set group = [] %}
                        {% if buttons[(title)] is defined %}
                            {% set group = buttons[(title)] %}
                        {% endif %}
                        {% set group = group|merge([button]) %}
                        {% set buttons = buttons|merge({(title): group}) %}
                    {% endfor %}
                    <div class="d-flex">
                        <div class="form-check">
                            <input type="checkbox" id="markAsExportedCheck" name="markAsExportedCheck" class="form-check-input" value="1" {% if form.markAsExported.vars.value == '1' %} checked="checked"{% endif %}>
                            <label class="form-check-label" for="markAsExportedCheck">{{ 'label.mark_as_exported'|trans }}</label>
                        </div>
                    </div>
                    <div class="d-flex">
                        <div class="btn-group me-auto dropup" id="export-buttons" role="group">
                            {% for group in buttons %}
                                {% set button = group.0 %}
                                {% if group|length == 1 %}
                                    <button type="button" id="export-{{ button.id }}-button" class="btn btn-success startExportBtn" data-type="{{ button.id }}">
                                        {{ ('button.' ~ button.title)|trans }}
                                    </button>
                                {% elseif group|length > 1 %}
                                    <div class="btn-group dropup">
                                        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            {{ ('button.' ~ button.title)|trans }}
                                        </button>
                                        <div class="dropdown-menu dropup">
                                            {% for button in group %}
                                                <a href="#" class="dropdown-item startExportBtn" data-type="{{ button.id }}">{{ (button.id)|trans({}, 'export') }}</a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% if showToggleButton %}
                            <button id="export-toggle-button" class="btn ms-auto{% if form.exported.vars.value == '4' %} d-none{% endif %}">
                                {{ icon('off') }}
                                {{ 'label.mark_as_exported'|trans }}
                            </button>
                            <button id="open-toggle-button" class="btn ms-auto {% if form.exported.vars.value == '5' %} d-none{% endif %}">
                                {{ icon('on') }}
                                {{ 'label.mark_as_open'|trans }}
                            </button>
                        {% endif %}
                    </div>
                {% endblock %}
                {% block box_body %}
                    <table class="table table-hover dataTable">
                        <thead>
                        <tr>
                            <th>{{ 'label.customer'|trans }}</th>
                            <th class="w-min text-end d-xs-none">{{ 'label.duration'|trans }}</th>
                            {# <th class="w-min text-end d-xs-none">{{ 'label.internalRate'|trans }}</th> #}
                            <th class="w-min text-end">{{ 'label.total_rate'|trans }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in by_customer %}
                            {% set currency = row.customer.currency %}
                            <tr>
                                <td>
                                    {{ widgets.label_customer(row.customer) }}
                                </td>
                                <td class="w-min text-end d-xs-none">
                                    {{ row.duration|duration(decimal) }}
                                </td>
                                {#
                                <td class="w-min text-end d-xs-none">
                                    {{ row.internalRate|money(currency) }}
                                </td>
                                #}
                                <td class="w-min text-end">
                                    {{ row.rate|money(currency) }}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endblock %}
            {% endembed %}

            {% set itemsAmount = entries|length %}
            {% if preview_limit %}
                {% set entries = entries|slice(0, preview_limit) %}
            {% endif %}

            {{ tables.datatable_header(tableName, columns, query) }}
            {% for entry in entries %}
                {% set currency = entry.project.customer.currency %}
                {% if entry.fixedRate is not null %}
                    {% set rate = entry.fixedRate %}
                {% else %}
                    {% set rate = entry.hourlyRate %}
                {% endif %}
                <tr>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'date') }}">
                        {{ entry.begin|date_short }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'user') }}">
                        {{ widgets.label_user(entry.user) }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'project') }}">
                        {{ widgets.label_project(entry.project) }}
                        <br>
                        <small>{{ widgets.label_customer(entry.project.customer) }}</small>
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'activity') }}">
                        {% if entry.activity is not null %}
                            {{ widgets.label_activity(entry.activity) }}
                        {% endif %}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'description') }}">
                        {{ entry.description|desc2html }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'unit_price') }}">
                        {{ rate|money(currency) }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'duration') }}" data-duration="{{ entry.duration }}">
                        {{ entry.duration|duration(decimal) }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'rate_internal') }}">
                        {{ entry.internalRate|money(currency) }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'total_rate') }}">
                        {{ entry.rate|money(currency) }}
                    </td>
                    <td class="{{ tables.data_table_column_class(tableName, columns, 'actions') }}">
                    {% if is_granted('edit_export', entry) %}
                        {% if entry.exported %}
                            <button type="button" class="btn btn-outline-secondary exportBtn active" data-toggle="button" aria-pressed="true"
                                    data-exported-text="{{ 'entryState.exported'|trans }}" data-clean-text="{{ 'entryState.not_exported'|trans }}" data-timesheet="{{ entry.id }}">
                            {{ 'entryState.exported'|trans }}
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-light exportBtn" data-toggle="button" aria-pressed="false"
                                    data-exported-text="{{ 'entryState.exported'|trans }}" data-clean-text="{{ 'entryState.not_exported'|trans }}" data-timesheet="{{ entry.id }}">
                            {{ 'entryState.not_exported'|trans }}
                            </button>
                        {% endif %}
                    {% else %}
                        {% if entry.exported %}
                            {{ 'entryState.exported'|trans }}
                        {% else %}
                            {{ 'entryState.not_exported'|trans }}
                        {% endif %}
                    {% endif %}
                    </td>
                </tr>
            {% endfor %}
            {% if preview_limit and itemsAmount > preview_limit %}
                <tr class="warning">
                    <td colspan="10">&raquo; {{ 'preview.skipped_rows'|trans({'%rows%': (itemsAmount - preview_limit)}) }}</td>
                </tr>
            {% endif %}
            {{ tables.data_table_footer(entries) }}
        {% endif %}
    {% endif %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        function updateTimesheetExportState(node, id, exported)
        {
            /** @type {KimaiAlert} */
            const ALERT = kimai.getPlugin('alert');
            /** @type {KimaiAPI} */
            const API = kimai.getPlugin('api');

            API.patch(
                '{{ path('export_timesheet', {id: '-s-'}) }}'.replace('-s-', id),
                {},
                function(data) {
                    const table = node.closest('table')
                    const row = node.closest('tr');
                    row.remove();
                    const list = table.querySelectorAll('tbody tr');
                    if(list.length === 0) {
                        document.querySelector('form#export-form button.performSearch').click();
                    }
                }
            );
        }

        document.addEventListener('kimai.initialized', function() {
            document.addEventListener('click', function (event) {
                const node = event.target;
                if (node.matches('.exportBtn')) {
                    if (node.dataset['timesheet'] !== undefined) {
                        const id = node.dataset['timesheet'];
                        updateTimesheetExportState(node, id, !node.classList.contains('active'));
                    }
                }

                {# Toggle the form, because by default it triggers the search #}
                if (node.matches('#export-buttons .startExportBtn')) {
                    document.getElementById('markAsExported').value = document.getElementById('markAsExportedCheck').checked ? 1 : 0;
                    document.getElementById('renderer').value = node.dataset['type'];
                    const form = document.getElementById("export-form");
                    const previousAction = form.action;
                    const previousMethod = form.method;
                    const previousTarget = form.target;
                    form.target = '_blank';
                    form.method = 'POST';
                    form.action = '{{ path('export_data') }}';
                    form.submit();
                    document.getElementById('renderer').value = '';
                    form.target = previousTarget;
                    form.method = previousMethod;
                    form.action = previousAction;
                }
            }, false);
        });

        {% if showToggleButton %}
            function confirmToggleState(doExport)
            {
                let ALERT = kimai.getPlugin('alert');
                let message = '{{ 'export.clear_all'|trans }}';
                let displayBtn = 'export-toggle-button';
                let hideBtn = 'open-toggle-button';

                if (doExport) {
                    message = '{{ 'export.mark_all'|trans }}';
                    displayBtn = 'open-toggle-button';
                    hideBtn = 'export-toggle-button';
                }

                ALERT.question(message, function(value) {
                    if (!value) {
                        return;
                    }

                    [].slice.call(document.querySelectorAll('.exportBtn')).map(function (element) {
                        element.click();
                    });

                    // ... so the button is re-enabled immediately - that should be fixed in a future update
                    document.getElementById(displayBtn).classList.remove('d-none');
                    document.getElementById(hideBtn).classList.add('d-none');
                });
            }

            document.getElementById('export-toggle-button').addEventListener('click', function (event) {
                confirmToggleState(true);
            }, false);

            document.getElementById('open-toggle-button').addEventListener('click', function (event) {
                confirmToggleState(false);
            }, false);
        {% endif %}

    </script>
{% endblock %}
