{% extends 'reporting/layout.html.twig' %}

{% block report_title %}{{ report_title|trans({}, 'reporting') }}{% endblock %}

{% block report_form %}
    {{ form_start(form, {'attr': {'class': 'd-flex form-reporting align-middle', 'id': 'user-filter-form'}}) }}
    {% if form.user is defined %}
        {{ form_row(form.user, {'label': false, 'row_attr': {'class': 'w-25 me-2'}}) }}
    {% elseif app.user != user %}
        {{ widgets.username(user) }}
    {% endif %}
    {{ form_row(form.date, {'label': false, 'row_attr': {'class': 'me-2'}}) }}
    <div class="btn-group"{% if form.sumType.vars.choices|length <= 1 %} style="display: none"{% endif %}>
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="{{ 'display'|icon }}"></i> <span class="caret"></span>
        </button>
        <ul class="dropdown-menu checkbox-menu">
            <li>
                {{ form_widget(form.sumType) }}
            </li>
        </ul>
    </div>
    {{ form_end(form) }}
{% endblock %}

{% block report %}

    {% embed '@theme/embeds/card.html.twig' %}
        {% import "macros/widgets.html.twig" as widgets %}
        {% block box_body_class %}{{ box_id }} table-responsive p-0 m-0{% endblock %}
        {% block box_body %}
            {#
            {% embed 'reporting/report_by_user_data.html.twig' %}
                {% block period_name %}
                    <th class="text-center text-nowrap{% if column is weekend %} weekend{% endif %}{% if column is today %} today{% endif %}">
                        {{ column|date_weekday }}
                    </th>
                {% endblock %}
                {% block column_classes_project -%}
                    {% if column.date is weekend %} weekend{% endif %}{% if column.date is today %} today{% endif %}
                {%- endblock %}
                {% block column_classes_activity -%}
                    {% if column.date is weekend %} weekend{% endif %}{% if column.date is today %} today{% endif %}
                {%- endblock %}
                {% block column_classes_total -%}
                    {% if column is weekend %} weekend{% endif %}
                {%- endblock %}
            {% endembed %}
            #}
            {% set totals = {'totals': 0} %}
            {% set columns = 2 %}
            <table class="table table-hover dataTable">
                <thead>
                    <tr>
                        <th>&nbsp;</th>
                        <th>&nbsp;</th>
                        {% for day in days.dateTimes %}
                            <th class="text-center text-nowrap{% if day is weekend %} weekend{% endif %}{% if day is today %} today{% endif %}">
                                {{ day|date_weekday }}
                            </th>
                            {% set columns = columns + 1 %}
                            {% set totals = totals|merge({(day|report_date): 0}) %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                {% set oldCustomer = null %}
                {% for pid, project in rows|sort((a,b) => a.project.customer.id <=> b.project.customer.id) %}
                    {% if oldCustomer is null or oldCustomer != project.project.customer.id %}
                        {% set oldCustomer = project.project.customer.id %}
                        <tr class="summary">
                            <td colspan="{{ columns }}">{{ widgets.label_customer(project.project.customer) }}</td>
                        </tr>
                    {% endif %}
                    {% set totals = totals|merge({'totals': (totals['totals'] + project.duration)}) %}
                    <tr class="project">
                        <td class="text-nowrap">
                            <strong>{{ widgets.label_project(project.project) }}</strong>
                        </td>
                        <td class="text-nowrap text-center total">{{ project.duration|duration }}</td>
                        {% for day in project.days.days %}
                            <td class="text-nowrap text-center day-total{% if day.date is weekend %} weekend{% endif %}{% if day.date is today %} today{% endif %}">
                                {% if day.duration > 0 %}
                                    {% set totals = totals|merge({(day.date|report_date): (totals[day.date|report_date] + day.duration)}) %}
                                    <strong>{{ day.duration|duration }}</strong>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% for activity in project.activities %}
                        <tr class="activity">
                            <td class="text-nowrap">
                                {{ widgets.label_activity(activity.activity) }}
                            </td>
                            <td class="text-nowrap text-center total">{{ activity.duration|duration }}</td>
                            {% for day in activity.days.days %}
                                <td class="text-nowrap text-center day-total{% if day.date is weekend %} weekend{% endif %}{% if day.date is today %} today{% endif %}">
                                    {% if day.duration > 0 %}
                                        {{ day.duration|duration }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="summary">
                        <td>{{ 'stats.durationTotal'|trans }}</td>
                        <td class="text-nowrap text-center total">{{ totals['totals']|duration }}</td>
                        {% for day in days.dateTimes %}
                            <td class="text-nowrap text-center day-total{% if day is weekend %} weekend{% endif %}">
                                {{ totals[day|report_date]|duration }}
                            </td>
                        {% endfor %}
                    </tr>
                </tfoot>
            </table>
        {% endblock %}
    {% endembed %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        document.addEventListener('kimai.initialized', function() {
            jQuery('#user-filter-form').on('change', function(ev) {
                jQuery(this).submit();
            });
        });
    </script>
{% endblock %}
